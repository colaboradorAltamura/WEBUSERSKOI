// ** MUI Imports
import Box from '@mui/material/Box';
import Card from '@mui/material/Card';
import CardHeader from '@mui/material/CardHeader';
import Table from '@mui/material/Table';
import TableBody from '@mui/material/TableBody';
import TableCell from '@mui/material/TableCell';
import TableContainer from '@mui/material/TableContainer';
import TableHead from '@mui/material/TableHead';
import TableRow from '@mui/material/TableRow';
import Typography from '@mui/material/Typography';

// ** Types

// ** Custom Components Imports
import { Button } from '@mui/material';
import { useEffect, useState } from 'react';
import Loader from 'src/@core/components/loader';
import CustomChip from 'src/@core/components/mui/chip';
import OptionsMenu from 'src/@core/components/option-menu';
import { getSourceEntityData, handleError, parseDateToShortString } from 'src/@core/coreHelper';
import { formatDate } from 'src/@core/utils/format';
import { dynamicGet } from 'src/services/entitiesDynamicServices';
import { ApplicantsStateTypes, IApplicant, QuotationStatusTypes, IApplicantQuotation } from 'src/types/@autogenerated';
import { IconButton, Tooltip, capitalize } from '@mui/material';
import Icon from 'src/@core/components/icon';
import { useRouter } from 'next/router';
import { nameof } from 'src/@core/coreHelper';

import { ThemeColor } from 'src/@core/layouts/types';
// import { t } from 'i18next';
import { useTranslation } from 'react-i18next';

interface IApplicantsListResponse {
  total: number;
  hasMore: boolean;
  items: IApplicant[];
}

interface IApplicantRow extends IApplicant {
  statusColor: ThemeColor;
  statusName: string;
}

interface IApplicantQuotationListResponse {
  total: number;
  hasMore: boolean;
  items: IApplicantQuotation[];
}

const WidgetOldestApplicants = () => {
  const router = useRouter();
  const [data, setData] = useState<any[] | null>(null);
  const [compError, setCompError] = useState<any[] | null>(null);
  const [closedApplicants, setQuotationsPendingApproval] = useState<any[]>([]);
  const [openApplicants, setPendingQuotationApplicants] = useState<any[]>([]);

  const { t } = useTranslation();

  useEffect(() => {
    const doAsync = async () => {
      // Hablar con miche
      try {
        const applicantsPendingQuotationResult = (await dynamicGet({
          params: `/cms/applicants/by-prop/${nameof<IApplicant>('applicantStateType')}/${
            ApplicantsStateTypes.PENDING_QUOTATION
          }`,
        })) as IApplicantsListResponse;

        const pendingApprovalQuotationsResult = (await dynamicGet({
          params: `/cms/applicantQuotations/by-prop/${nameof<IApplicantQuotation>('applicantQuotationStatusType')}/${
            QuotationStatusTypes.PENDING_APPROVAL
          }`,
        })) as IApplicantQuotationListResponse;

        const pendingQuotationsResult = (await dynamicGet({
          params: `/cms/applicantQuotations/by-prop/${nameof<IApplicantQuotation>('applicantQuotationStatusType')}/${
            QuotationStatusTypes.PENDING
          }`,
        })) as IApplicantQuotationListResponse;
        const pendingApprovalQuotations = pendingApprovalQuotationsResult.items.concat(pendingQuotationsResult.items);
        console.log(pendingApprovalQuotations);
        const renderList: any[] = [];
        applicantsPendingQuotationResult.items.forEach((applicant) => {
          const quotation: IApplicantQuotation | undefined = pendingApprovalQuotations.find((item) => {
            return applicant.id === item.applicantId;
          });
          const statusName = getSourceEntityData({ obj: quotation, key: 'applicantQuotationStatusType' }).name;

          let statusColor: ThemeColor = 'warning';

          if (quotation && quotation.applicantQuotationStatusType === QuotationStatusTypes.PENDING)
            statusColor = 'info';

          const applicantRow: IApplicantRow = { ...applicant, statusName: t(statusName), statusColor };
          renderList.push(applicantRow);
        });

        const orderedList = renderList.sort(
          (a: IApplicant, b: IApplicant) =>
            new Date(a.updatedAt as any).getTime() - new Date(b.updatedAt as any).getTime()
        );

        const finalList = orderedList.splice(0, 5);
        console.log(finalList);
        setData(finalList);
      } catch (e: any) {
        setCompError(e);
      }
    };

    doAsync();
  }, []);

  return (
    <Card>
      <CardHeader
        title={capitalize(t('open quotations'))}
        action={<Button onClick={() => router.push(`/applicants`)}>{t('View all')}</Button>}
      />
      {!data && <Loader sx={{ marginBottom: 10 }} />}
      {compError && (
        <Typography noWrap variant='h5'>
          Ups! Error de conexi√≥n
        </Typography>
      )}
      {data && (
        <TableContainer>
          <Table>
            <TableHead>
              <TableRow
                sx={{ '& .MuiTableCell-root': { py: 2, borderTop: (theme) => `1px solid ${theme.palette.divider}` } }}
              >
                <TableCell></TableCell>

                <TableCell>{t('name')}</TableCell>
                <TableCell>{t('health insurance')}</TableCell>
                <TableCell>{t('status')}</TableCell>
                <TableCell>{t('last update')}</TableCell>
              </TableRow>
            </TableHead>

            <TableBody>
              {data.length === 0 && (
                <Typography noWrap variant='h5'>
                  No hay presupuestos pendientes
                </Typography>
              )}
              {data.length > 0 &&
                data.map((row: IApplicantRow, index) => {
                  return (
                    <TableRow
                      key={index}
                      sx={{
                        '&:last-child .MuiTableCell-root': { pb: (theme) => `${theme.spacing(6)} !important` },
                        '& .MuiTableCell-root': { border: 0, py: (theme) => `${theme.spacing(2.25)} !important` },
                        '&:first-of-type .MuiTableCell-root': { pt: (theme) => `${theme.spacing(4.5)} !important` },
                      }}
                    >
                      <TableCell>
                        <Tooltip title='Ver contenido'>
                          <IconButton
                            size='small'
                            sx={{ color: 'text.secondary' }}
                            onClick={() => {
                              router.push(`/applicants/${row.id}`);
                            }}
                          >
                            <Icon icon='tabler:eye' />
                          </IconButton>
                        </Tooltip>
                      </TableCell>

                      <TableCell>
                        <Box sx={{ display: 'flex', alignItems: 'center', '& img': { mr: 4 } }}>
                          <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
                            <Typography
                              noWrap
                              sx={{ fontWeight: 500, color: 'text.secondary', textTransform: 'capitalize' }}
                            >
                              {row.applicantFullname}
                            </Typography>
                          </Box>
                        </Box>
                      </TableCell>
                      <TableCell>
                        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
                          <Typography noWrap variant='body2' sx={{ color: 'text.disabled' }}>
                            {row.insurance.length > 0 ? row.insurance : '-'}
                          </Typography>
                        </Box>
                      </TableCell>
                      <TableCell>
                        <CustomChip
                          rounded
                          size='small'
                          skin='light'
                          label={row.statusName}
                          color={row.statusColor}
                          sx={{ textTransform: 'capitalize' }}
                        />
                      </TableCell>
                      <TableCell>
                        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
                          <Typography noWrap variant='body2' sx={{ color: 'text.disabled' }}>
                            {parseDateToShortString(row.updatedAt as any)}
                          </Typography>
                        </Box>
                      </TableCell>
                    </TableRow>
                  );
                })}
            </TableBody>
          </Table>
        </TableContainer>
      )}
    </Card>
  );
};

export default WidgetOldestApplicants;
